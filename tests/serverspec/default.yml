- hosts: localhost
  pre_tasks:
    - name: Update EPEL
      # XXX work around cache inconsistency issue by updating cache.
      # TODO remove epel-release from the box. the epel was used to install
      # ansible from epel repository and should not be there. see #22
      yum:
        name: epel-release
        state: latest
        update_cache: yes
      when: ansible_os_family == 'RedHat'
  roles:
    - name: reallyenglish.redhat-repo
      when: ansible_os_family == 'RedHat'
    - ansible-role-rabbitmq
  vars:
    redhat_repo_extra_packages:
      - epel-release
    redhat_repo:
      epel:
        mirrorlist: "http://mirrors.fedoraproject.org/mirrorlist?repo=epel-{{ ansible_distribution_major_version }}&arch={{ ansible_architecture }}"
        gpgcheck: yes
        enabled: yes
    rabbitmq_cookie: "ABCDEFGHIJK"
    rabbitmq_env:
      foo: 1
      BAR: 2
      USE_LONGNAME: 1
    rabbitmq_plugins:
      - name: rabbitmq_trust_store
        state: disabled
    rabbitmq_flags:
      FOO: bar
    rabbitmq_users:
      - name: root
        password: root
        state: present
        vhost: /
      - name: guest
        state: absent
        vhost: /
        password: guest
    rabbitmq_config: |
      [
        {rabbit,
         [
          {tcp_listeners, [5672] },
          {log_levels, [{connection, info}]},
          {vm_memory_high_watermark, 0.4},
          {vm_memory_high_watermark_paging_ratio, 0.5},
          {disk_free_limit, "50MB"}
         ]
        }
      ].
    rabbitmq_cluster_enable: yes
    rabbitmq_cluster_name: "foo"
    rabbitmq_cluster_nodes:
      - "{{ ansible_fqdn }}"
    rabbitmq_management_user:
      name: vagrant
      password: vagrant
      create: yes
